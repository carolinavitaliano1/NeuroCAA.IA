<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† NeuroCAA</title>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { text-align: center; }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    button {
      padding: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .generate { background: #667eea; color: white; }
    .save { background: #48bb78; color: white; }
    .pdf { background: #4299e1; color: white; }
    .clear { background: #f56565; color: white; }

    .board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .cell {
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
    }

    .cell img {
      max-width: 80px;
      max-height: 80px;
    }

    .history {
      margin-top: 25px;
    }

    .history-item {
      background: #f1f5f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #48bb78;
      color: white;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>üß† NeuroCAA</h1>

  <div class="input-group">
    <input id="phraseInput" placeholder="Digite a frase..." />
    <button class="generate" onclick="generateBoard()">Gerar</button>
  </div>

  <input id="boardTitle" placeholder="T√≠tulo da prancha (opcional)" style="width:100%; padding:8px;" />

  <div id="board" class="board"></div>

  <div style="margin-top:15px; display:flex; gap:10px;">
    <button class="save" onclick="saveBoard()">üíæ Salvar</button>
    <button class="pdf" onclick="exportBoardToPDF()">üìÑ PDF</button>
    <button class="clear" onclick="clearBoard()">üóëÔ∏è Limpar</button>
  </div>

  <div class="history">
    <h3>üìö Hist√≥rico</h3>
    <div id="historyList"></div>
  </div>
</div>

<script>
const API = 'https://api.arasaac.org/api/pictograms/pt/search/';
let currentBoard = [];

const CAA_COLORS = [
  { name:'Amarelo', color:'#FDE047', label:'Pessoas / Pronomes' },
  { name:'Verde', color:'#86EFAC', label:'Verbos / A√ß√µes' },
  { name:'Azul', color:'#93C5FD', label:'Adjetivos' },
  { name:'Laranja', color:'#FDBA74', label:'Substantivos' },
  { name:'Rosa', color:'#F9A8D4', label:'Express√µes sociais' },
  { name:'Branco', color:'#FFFFFF', label:'Artigos' },
  { name:'Roxo', color:'#C4B5FD', label:'Preposi√ß√µes' },
  { name:'Marrom', color:'#D6B28A', label:'Adv√©rbios' }
];

function toast(msg, error=false) {
  const t = document.createElement('div');
  t.className = 'toast';
  if(error) t.style.background='#f56565';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function saveLS(data){ localStorage.setItem('pranchas',JSON.stringify(data)); }
function loadLS(){ return JSON.parse(localStorage.getItem('pranchas')||'[]'); }

async function generateBoard(){
  const phrase = phraseInput.value.trim();
  if(!phrase) return;

  currentBoard = [];
  for(const word of phrase.split(/\s+/)){
    let data=[];
    try{
      const res=await fetch(API+encodeURIComponent(word));
      data=await res.json();
    }catch{}
    const pic=data[0];
    currentBoard.push({
      word,
      img: pic ? `https://static.arasaac.org/pictograms/${pic._id}/${pic._id}_300.png` : null,
      customText:null,
      bgColor:'#ffffff',
      borderColor:'#e2e8f0'
    });
  }
  renderBoard();
}

function renderBoard(){
  board.innerHTML='';
  const title=boardTitle.value.trim();
  if(title){
    const t=document.createElement('div');
    t.textContent=title;
    t.style.fontWeight='700';
    t.style.gridColumn='1/-1';
    t.style.textAlign='center';
    board.appendChild(t);
  }

  currentBoard.forEach((item,i)=>{
    const cell=document.createElement('div');
    cell.className='cell';
    cell.style.background=item.bgColor;
    cell.style.border=`2px solid ${item.borderColor}`;
    cell.innerHTML=`
      ${item.img?`<img src="${item.img}">`:''}
      <div>${item.customText||item.word}</div>`;
    cell.onclick=()=>openQuickEditModal(i);
    board.appendChild(cell);
  });
}

async function openQuickEditModal(index) {
  const item = currentBoard[index];

  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  `;

  const modal = document.createElement('div');
  modal.style.cssText = `
    background:#fff;
    padding:20px;
    border-radius:12px;
    max-width:420px;
    width:100%;
    max-height:90vh;
    overflow:auto;
  `;

  modal.innerHTML = `
    <h3>‚úèÔ∏è Editar "${item.word}"</h3>

    <label>Texto:</label>
    <input id="editText" value="${item.customText || item.word}"
      style="width:100%; padding:8px; margin-bottom:10px"/>

    <label>üé® Cor de fundo:</label>
    <button id="btnBg" style="width:100%; margin-bottom:6px">Selecionar cor sem√¢ntica</button>
    <div id="bgColors" style="display:none; margin-bottom:10px"></div>

    <label>üñçÔ∏è Cor da borda:</label>
    <button id="btnBorder" style="width:100%; margin-bottom:6px">Selecionar cor sem√¢ntica</button>
    <div id="borderColors" style="display:none; margin-bottom:10px"></div>

    <button id="searchPic">üîç Buscar outro pictograma</button>
    <br><br>

    <input type="file" id="uploadImg" accept="image/*"/>

    <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end">
      <button id="saveEdit">üíæ Salvar</button>
      <button id="closeEdit">‚ùå Fechar</button>
    </div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  /* ========= CORES SEM√ÇNTICAS ========= */

  const bgBox = modal.querySelector('#bgColors');
  const borderBox = modal.querySelector('#borderColors');

  function renderColorButtons(target, applyFn) {
    target.innerHTML = '';
    CAA_COLORS.forEach(c => {
      const btn = document.createElement('button');
      btn.textContent = `${c.name} ‚Äì ${c.label}`;
      btn.style.cssText = `
        background:${c.color};
        border:2px solid #333;
        padding:6px;
        border-radius:6px;
        margin-bottom:4px;
        width:100%;
        cursor:pointer;
        text-align:left;
      `;
      btn.onclick = () => {
        applyFn(c.color);
        renderBoard();
        target.style.display = 'none';
      };
      target.appendChild(btn);
    });
  }

  renderColorButtons(bgBox, color => item.bgColor = color);
  renderColorButtons(borderBox, color => item.borderColor = color);

  modal.querySelector('#btnBg').onclick = () => {
    bgBox.style.display = bgBox.style.display === 'none' ? 'block' : 'none';
    borderBox.style.display = 'none';
  };

  modal.querySelector('#btnBorder').onclick = () => {
    borderBox.style.display = borderBox.style.display === 'none' ? 'block' : 'none';
    bgBox.style.display = 'none';
  };

  /* ========= BUSCAR PICTOGRAMA ========= */

  modal.querySelector('#searchPic').onclick = async () => {
    const res = await fetch(API + encodeURIComponent(item.word));
    const data = await res.json();
    if (!data.length) {
      toast('Nenhuma imagem encontrada', true);
      return;
    }

    modal.innerHTML = '<h3>Escolha um pictograma</h3>';
    const grid = document.createElement('div');
    grid.style.cssText = `
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    `;

    data.slice(0,9).forEach(p => {
      const img = document.createElement('img');
      img.src = `https://static.arasaac.org/pictograms/${p._id}/${p._id}_300.png`;
      img.style.width = '100%';
      img.style.cursor = 'pointer';
      img.onclick = () => {
        item.img = img.src;
        renderBoard();
        overlay.remove();
      };
      grid.appendChild(img);
    });

    modal.appendChild(grid);
  };

  /* ========= UPLOAD DE IMAGEM ========= */

  modal.querySelector('#uploadImg').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      item.img = ev.target.result;
      renderBoard();
      overlay.remove();
    };
    reader.readAsDataURL(file);
  };

  /* ========= SALVAR / FECHAR ========= */

  modal.querySelector('#saveEdit').onclick = () => {
    item.customText = document.getElementById('editText').value.trim();
    renderBoard();
    overlay.remove();
  };

  modal.querySelector('#closeEdit').onclick = () => overlay.remove();
}


function saveBoard(){
  const list=loadLS();
  list.push({id:Date.now(),date:new Date().toLocaleString('pt-BR'),board:currentBoard});
  saveLS(list); renderHistory(); toast('Prancha salva!');
}

function clearBoard(){ currentBoard=[]; board.innerHTML=''; phraseInput.value=''; }

function renderHistory(){
  historyList.innerHTML='';
  loadLS().reverse().forEach(b=>{
    const d=document.createElement('div');
    d.className='history-item';
    d.innerHTML=`${b.date}<br>${b.board.map(x=>x.word).join(' ')}`;
    historyList.appendChild(d);
  });
}

function exportBoardToPDF(){
  html2canvas(board).then(c=>{
    const pdf=new window.jspdf.jsPDF('landscape');
    pdf.addImage(c.toDataURL(),'PNG',10,10,280,0);
    pdf.save('prancha-neurocaa.pdf');
  });
}

renderHistory();
</script>
</body>
</html>
