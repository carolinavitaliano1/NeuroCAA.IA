<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§  NeuroCAA</title>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { text-align: center; }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }

    button {
      padding: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .generate { background: #667eea; color: white; }
    .save { background: #48bb78; color: white; }
    .pdf { background: #4299e1; color: white; }
    .clear { background: #f56565; color: white; }

    .board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .cell {
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
    }

    .cell img {
      max-width: 80px;
      max-height: 80px;
    }

    .history {
      margin-top: 25px;
    }

    .history-item {
      background: #f1f5f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #48bb78;
      color: white;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>ğŸ§  NeuroCAA</h1>

  <div class="input-group">
    <input id="phraseInput" placeholder="Digite a frase..." />
    <button class="generate" onclick="generateBoard()">Gerar</button>
  </div>

  <input id="boardTitle" placeholder="TÃ­tulo da prancha (opcional)" style="width:100%; padding:8px;" />

  <div id="board" class="board"></div>

  <div style="margin-top:15px; display:flex; gap:10px;">
    <button class="save" onclick="saveBoard()">ğŸ’¾ Salvar</button>
    <button class="pdf" onclick="exportBoardToPDF()">ğŸ“„ PDF</button>
    <button class="clear" onclick="clearBoard()">ğŸ—‘ï¸ Limpar</button>
  </div>

  <div class="history">
    <h3>ğŸ“š HistÃ³rico</h3>
    <div id="historyList"></div>
  </div>
</div>

<script>
const API = 'https://api.arasaac.org/api/pictograms/pt/search/';
let currentBoard = [];

const CAA_COLORS = [
  { name:'Amarelo', color:'#FDE047', label:'Pessoas / Pronomes' },
  { name:'Verde', color:'#86EFAC', label:'Verbos / AÃ§Ãµes' },
  { name:'Azul', color:'#93C5FD', label:'Adjetivos' },
  { name:'Laranja', color:'#FDBA74', label:'Substantivos' },
  { name:'Rosa', color:'#F9A8D4', label:'ExpressÃµes sociais' },
  { name:'Branco', color:'#FFFFFF', label:'Artigos' },
  { name:'Roxo', color:'#C4B5FD', label:'PreposiÃ§Ãµes' },
  { name:'Marrom', color:'#D6B28A', label:'AdvÃ©rbios' }
];

function toast(msg, error=false) {
  const t = document.createElement('div');
  t.className = 'toast';
  if(error) t.style.background='#f56565';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function saveLS(data){ localStorage.setItem('pranchas',JSON.stringify(data)); }
function loadLS(){ return JSON.parse(localStorage.getItem('pranchas')||'[]'); }

async function generateBoard(){
  const phrase = phraseInput.value.trim();
  if(!phrase) return;

  currentBoard = [];
  for(const word of phrase.split(/\s+/)){
    let data=[];
    try{
      const res=await fetch(API+encodeURIComponent(word));
      data=await res.json();
    }catch{}
    const pic=data[0];
    currentBoard.push({
      word,
      img: pic ? `https://static.arasaac.org/pictograms/${pic._id}/${pic._id}_300.png` : null,
      customText:null,
      bgColor:'#ffffff',
      borderColor:'#e2e8f0'
    });
  }
  renderBoard();
}

function renderBoard(){
  board.innerHTML='';
  const title=boardTitle.value.trim();
  if(title){
    const t=document.createElement('div');
    t.textContent=title;
    t.style.fontWeight='700';
    t.style.gridColumn='1/-1';
    t.style.textAlign='center';
    board.appendChild(t);
  }

  currentBoard.forEach((item,i)=>{
    const cell=document.createElement('div');
    cell.className='cell';
    cell.style.background=item.bgColor;
    cell.style.border=`2px solid ${item.borderColor}`;
    cell.innerHTML=`
      ${item.img?`<img src="${item.img}">`:''}
      <div>${item.customText||item.word}</div>`;
    cell.onclick=()=>openQuickEditModal(i);
    board.appendChild(cell);
  });
}

async function openQuickEditModal(index){
  const item=currentBoard[index];
  const overlay=document.createElement('div');
  overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:9999;';
  
  const modal=document.createElement('div');
  modal.style.cssText='background:white;padding:20px;border-radius:12px;max-width:420px;width:100%;';

  modal.innerHTML=`
    <h3>âœï¸ Editar "${item.word}"</h3>
    <input id="editText" value="${item.customText||item.word}" style="width:100%;margin-bottom:8px"/>
    <label>ğŸ¨ Fundo</label>
    <input type="color" id="bgColor" value="${item.bgColor}" style="width:100%"/>
    <label>ğŸ–ï¸ Borda</label>
    <input type="color" id="borderColor" value="${item.borderColor}" style="width:100%"/>
    <strong>ğŸ“š Categoria CAA</strong>
    <div id="colorGrid"></div>
    <button id="searchPic">ğŸ” Buscar pictograma</button><br><br>
    <input type="file" id="uploadImg"/>
    <br><br>
    <button id="saveEdit">ğŸ’¾ Salvar</button>
    <button onclick="document.body.removeChild(this.parentElement.parentElement)">âŒ Fechar</button>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  const grid=modal.querySelector('#colorGrid');
  CAA_COLORS.forEach(c=>{
    const b=document.createElement('button');
    b.textContent=`${c.name} â€“ ${c.label}`;
    b.style.background=c.color;
    b.onclick=()=>{ item.bgColor=c.color; item.borderColor=c.color; renderBoard(); };
    grid.appendChild(b);
  });

  modal.querySelector('#saveEdit').onclick=()=>{
    item.customText=editText.value.trim();
    item.bgColor=bgColor.value;
    item.borderColor=borderColor.value;
    renderBoard();
    overlay.remove();
  };

  modal.querySelector('#uploadImg').onchange=e=>{
    const r=new FileReader();
    r.onload=ev=>{ item.img=ev.target.result; renderBoard(); overlay.remove(); };
    r.readAsDataURL(e.target.files[0]);
  };

  modal.querySelector('#searchPic').onclick=async()=>{
    const res=await fetch(API+encodeURIComponent(item.word));
    const data=await res.json();
    modal.innerHTML='<h3>Escolha</h3>';
    data.slice(0,9).forEach(p=>{
      const img=document.createElement('img');
      img.src=`https://static.arasaac.org/pictograms/${p._id}/${p._id}_300.png`;
      img.onclick=()=>{ item.img=img.src; renderBoard(); overlay.remove(); };
      modal.appendChild(img);
    });
  };
}

function saveBoard(){
  const list=loadLS();
  list.push({id:Date.now(),date:new Date().toLocaleString('pt-BR'),board:currentBoard});
  saveLS(list); renderHistory(); toast('Prancha salva!');
}

function clearBoard(){ currentBoard=[]; board.innerHTML=''; phraseInput.value=''; }

function renderHistory(){
  historyList.innerHTML='';
  loadLS().reverse().forEach(b=>{
    const d=document.createElement('div');
    d.className='history-item';
    d.innerHTML=`${b.date}<br>${b.board.map(x=>x.word).join(' ')}`;
    historyList.appendChild(d);
  });
}

function exportBoardToPDF(){
  html2canvas(board).then(c=>{
    const pdf=new window.jspdf.jsPDF('landscape');
    pdf.addImage(c.toDataURL(),'PNG',10,10,280,0);
    pdf.save('prancha-neurocaa.pdf');
  });
}

renderHistory();
</script>
</body>
</html>
